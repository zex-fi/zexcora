services:
  cora:
    image: cora:dev
    command: "app.main:app"
    container_name: cora
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./init_db.sql:/app/init_db.sql
      - ./zex_state.pb:/app/zex_state.pb
      - logs:/app/logs

    ports:
      - 127.0.0.1:15782:80
    environment:
      - LOG_DIR=/app/logs
      - ZEX__SEQUENCER_MODE=docker
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - zex
    depends_on:
      - state-manager

  state-manager:
    image: cora:dev
    working_dir: /app/state_manager
    command: "main:app"
    container_name: state-manager
    volumes:
      - ./zex_state.pb:/app/public/zex_state.pb:ro
      - ./state_manager/config.yaml:/app/state_manager/config.yaml

    expose:
      - 80
    ports:
      - 127.0.0.1:15783:80

    networks:
      - zex
    depends_on:
      event-broker:
        condition: service_healthy
        restart: true

  event-distributor:
    image: cora:dev
    working_dir: /app/event_distributor
    command: "main:app"
    container_name: event-distributor
    volumes:
      - ./event_distributor/config.yaml:/app/event_distributor/config.yaml

    expose:
      - 80
    ports:
      - 127.0.0.1:15784:80
    environment:
      - EVENT_DISTRIBUTOR__BROKER__HOST=event-broker
    networks:
      - zex
    depends_on:
      event-broker:
        condition: service_healthy
        restart: true

  websocket-service:
    image: cora:dev
    working_dir: /app/websocket_service
    command: "main:app"
    container_name: websocket-service
    volumes:
      - ./websocket_service/config.yaml:/app/websocket_service/config.yaml

    expose:
      - 80
    ports:
      - 127.0.0.1:15785:80
    environment:
      - WEBSOCKET_SERVICE__BROKER__HOST=event-broker
    networks:
      - zex
    depends_on:
      event-broker:
        condition: service_healthy
        restart: true

  event-broker:
    image: rabbitmq:4-management
    container_name: event-broker
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: cora_event_broker_super_secure_password
    ports:
      - 127.0.0.1:15672:15672
      - 127.0.0.1:5672:5672
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 5m
      timeout: 5s
      retries: 3
      start_period: 2s
      start_interval: 5s
    networks:
      - zex

  log-viewer:
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "8080:8080"
    networks:
      - zex

volumes:
  logs:
  db1:
  db2:
  db3:
  rabbitmq_data:

networks:
  zex:
    external: true
